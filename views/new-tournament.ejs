<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <title>New Tournament - FC26 Tracker</title>
  <link rel="stylesheet" href="/style.css?v=12" />
</head>
<body>
  <header class="topbar">
    <h1>Create Tournament</h1>
    <a href="/dashboard">‚Üê Dashboard</a>
  </header>

  <section class="card">
    <form method="post" action="/tournaments" id="tForm">
      <label>Tournament name</label>
      <input name="name" required placeholder="Weekend League" />

      <h3>Players (2 to 10)</h3>
      <div id="players"></div>
      <button type="button" id="addPlayer">+ Add player</button>
      <br><br>
      <button type="submit">Create</button>
    </form>
  </section>

  <script>
    const leagues = <%- JSON.stringify(grouped) %>;
    const users = <%- JSON.stringify(users) %>;
    const playersDiv = document.getElementById('players');
    const addBtn = document.getElementById('addPlayer');

    function userSelect() {
      const s = document.createElement('select');
      s.required = true;
      const ph = document.createElement('option');
      ph.value = '';
      ph.textContent = 'Select user';
      ph.disabled = true;
      ph.selected = true;
      s.appendChild(ph);
      users.forEach(u => {
        const o = document.createElement('option');
        o.value = String(u.id);
        o.textContent = u.username;
        s.appendChild(o);
      });
      return s;
    }

    function teamSelect(){
      const s = document.createElement('select');
      s.required = true;
      for (const league in leagues){
        const g = document.createElement('optgroup');
        g.label = league;
        leagues[league].forEach(team => {
          const o = document.createElement('option');
          o.value = team.id;
          o.textContent = `${team.name} (${team.league})`;
          g.appendChild(o);
        });
        s.appendChild(g);
      }
      return s;
    }

    function reindexRows() {
      [...playersDiv.children].forEach((row, idx) => {
        row.querySelector('.user-select').name = `players[${idx}][userId]`;
        row.querySelector('.team-select').name = `players[${idx}][teamId]`;
      });
    }

    function syncUserOptions() {
      const selects = [...playersDiv.querySelectorAll('.user-select')];
      const selected = selects.map(s => s.value).filter(Boolean);

      selects.forEach(sel => {
        [...sel.options].forEach(opt => {
          if (!opt.value) return;
          opt.disabled = selected.includes(opt.value) && sel.value !== opt.value;
        });
      });
    }

    function addPlayerRow() {
      if (playersDiv.children.length >= 10) return;
      const row = document.createElement('div');
      row.className = 'player-row';

      const userSel = userSelect();
      userSel.className = 'user-select';
      userSel.addEventListener('change', syncUserOptions);

      const teamSel = teamSelect();
      teamSel.className = 'team-select';

      const del = document.createElement('button');
      del.type = 'button';
      del.textContent = 'Remove';
      del.onclick = () => {
        row.remove();
        reindexRows();
        syncUserOptions();
      };

      row.appendChild(userSel);
      row.appendChild(teamSel);
      row.appendChild(del);
      playersDiv.appendChild(row);
      reindexRows();
      syncUserOptions();
    }

    document.getElementById('tForm').addEventListener('submit', (e) => {
      const values = [...playersDiv.querySelectorAll('.user-select')].map(s => s.value).filter(Boolean);
      const unique = new Set(values);
      if (values.length !== unique.size) {
        e.preventDefault();
        alert('Each user can only be selected once.');
      }
    });

    addBtn.addEventListener('click', addPlayerRow);
    addPlayerRow();
    addPlayerRow();
  </script>
</body>
</html>

<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <meta name="theme-color" content="#0c1020" />
  <title><%= tournament.name %> - FC26 Tracker</title>
  <link rel="stylesheet" href="/style.css?v=14" />
</head>
<body>
  <header class="topbar">
    <h1><%= tournament.name %></h1>
    <a href="/dashboard">‚Üê Dashboard</a>
  </header>

  <% if (canManageTournament) { %>
    <section class="card">
      <h2>Tournament Settings</h2>
      <form method="post" action="/tournaments/<%= tournament.id %>/update" class="inline">
        <input name="name" value="<%= tournament.name %>" required />
        <button type="submit">Rename</button>
      </form>
      <form method="post" action="/tournaments/<%= tournament.id %>/delete" onsubmit="return confirm('Delete this tournament? This cannot be undone.')" style="margin-top:10px;">
        <button type="submit" style="background:#ff6b6b;color:#fff;">Delete Tournament</button>
      </form>
    </section>
  <% } %>

  <% if (championship && championship.finalists.length === 2) { %>
    <% const finalistA = championship.finalists[0]; %>
    <% const finalistB = championship.finalists[1]; %>
    <% const aggA = championship.aggregate.get(finalistA.playerId) || 0; %>
    <% const aggB = championship.aggregate.get(finalistB.playerId) || 0; %>
    <section class="card championship-card">
      <div class="championship-head">
        <h2>üèÜ Final</h2>
        <span class="championship-badge">Top 2</span>
      </div>

      <div class="championship-versus">
        <div class="champ-side <%= championship.winner && championship.winner.playerId === finalistA.playerId ? 'champ-winner' : '' %>">
          <% if (finalistA.team) { %>
            <img class="logo championship-logo" src="<%= finalistA.team.logo %>" alt="logo" />
          <% } %>
          <div>
            <div class="champ-player">
              <%= finalistA.playerName %>
              <span class="champ-inline-score"><%= aggA %></span>
            </div>
            <div class="champ-team"><%= finalistA.team?.name || finalistA.teamId %></div>
          </div>
        </div>

        <div class="champ-side right <%= championship.winner && championship.winner.playerId === finalistB.playerId ? 'champ-winner' : '' %>">
          <div>
            <div class="champ-player">
              <%= finalistB.playerName %>
              <span class="champ-inline-score"><%= aggB %></span>
            </div>
            <div class="champ-team"><%= finalistB.team?.name || finalistB.teamId %></div>
          </div>
          <% if (finalistB.team) { %>
            <img class="logo championship-logo" src="<%= finalistB.team.logo %>" alt="logo" />
          <% } %>
        </div>
      </div>

      <div class="championship-foot">
        <span>Aggregate: <strong><%= aggA %> - <%= aggB %></strong></span>
        <span>Legs: <strong><%= championship.legsPlayed %>/<%= championship.legsTotal %></strong></span>
        <% if (championship.winner) { %>
          <span class="champion-pill">Champion: <strong><%= championship.winner.playerName %></strong></span>
        <% } else { %>
          <span class="in-progress-pill">Championship in progress‚Ä¶</span>
        <% } %>
      </div>
    </section>
  <% } %>

  <section class="card standings-card">
    <h2>Regular Season Standings</h2>
    <div class="table-wrap">
    <table class="standings-table">
      <thead>
        <tr><th>#</th><th>Player</th><th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th></tr>
      </thead>
      <tbody>
      <% standings.forEach((r, idx) => { %>
        <tr>
          <td><%= idx + 1 %></td>
          <td><%= r.playerName %></td>
          <td>
            <% if (r.team) { %>
              <img class="logo" src="<%= r.team.logo %>" alt="logo" /> <%= r.team.name %>
            <% } else { %>
              <%= r.teamId %>
            <% } %>
          </td>
          <td><%= r.played %></td><td><%= r.wins %></td><td><%= r.draws %></td><td><%= r.losses %></td>
          <td><%= r.goalsFor %></td><td><%= r.goalsAgainst %></td><td><%= r.goalDiff %></td><td><strong><%= r.points %></strong></td>
        </tr>
      <% }) %>
      </tbody>
    </table>
    </div>
  </section>


  <section class="card">
    <h2>Tournament Statistics</h2>
    <ul>
      <li>Matches played: <strong><%= stats.matchesPlayed %> / <%= stats.totalMatches %></strong></li>
      <li>Total goals: <strong><%= stats.totalGoals %></strong></li>
      <li>Average goals per match: <strong><%= stats.avgGoals %></strong></li>
      <% if (stats.topAttack) { %><li>Top attack: <strong><%= stats.topAttack.playerName %></strong> (<%= stats.topAttack.goalsFor %> goals)</li><% } %>
      <% if (stats.bestDefense) { %><li>Best defense: <strong><%= stats.bestDefense.playerName %></strong> (<%= stats.bestDefense.goalsAgainst %> conceded)</li><% } %>
      <% if (stats.elMasCulo) { %><li>El m√°s culo: <strong><%= stats.elMasCulo.playerName %></strong> (<%= stats.elMasCulo.goalsFor %> GF, <%= stats.elMasCulo.goalsAgainst %> GA)</li><% } %>
    </ul>
  </section>

  <section class="card">
    <h2>Fixtures & Results (Double Round-Robin)</h2>
    <div class="fixtures-grid">
      <% matches.forEach(m => { const played = !(m.home_goals === null || m.away_goals === null); %>
        <article class="fixture-card <%= played ? 'played' : 'pending' %>">
          <div class="fixture-top">
            <span class="round-pill"><%= m.stage === 'final' ? `Championship Leg ${m.round_no}` : `Round ${m.round_no}` %></span>
            <span class="status-pill <%= played ? 'done' : 'upcoming' %>"><%= played ? 'Final' : 'Pending' %></span>
          </div>

          <div class="teams-line">
            <div class="team-side <%= played && m.home_goals > m.away_goals ? 'winner' : '' %>">
              <% if (m.home_team) { %><img class="logo" src="<%= m.home_team.logo %>" alt="logo" /><% } %>
              <div>
                <div class="player-name"><%= m.home_name %></div>
                <div class="team-name"><%= m.home_team?.name || m.home_team_id %></div>
              </div>
            </div>

            <div class="score-box <%= played ? 'show' : '' %>">
              <% if (played) { %>
                <strong><%= m.home_goals %> - <%= m.away_goals %></strong>
              <% } else { %>
                <span>vs</span>
              <% } %>
            </div>

            <div class="team-side right <%= played && m.away_goals > m.home_goals ? 'winner' : '' %>">
              <div>
                <div class="player-name"><%= m.away_name %></div>
                <div class="team-name"><%= m.away_team?.name || m.away_team_id %></div>
              </div>
              <% if (m.away_team) { %><img class="logo" src="<%= m.away_team.logo %>" alt="logo" /><% } %>
            </div>
          </div>

          <% if (canEditScores) { %>
            <form method="post" action="/matches/<%= m.id %>/result" class="result-form">
              <input type="number" min="0" name="home_goals" required value="<%= played ? m.home_goals : '' %>" />
              <span>-</span>
              <input type="number" min="0" name="away_goals" required value="<%= played ? m.away_goals : '' %>" />
              <button type="submit"><%= played ? 'Update result' : 'Save result' %></button>
            </form>
          <% } %>
        </article>
      <% }) %>
    </div>
  </section>
</body>
</html>
